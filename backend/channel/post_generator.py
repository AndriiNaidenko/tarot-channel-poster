import logging
import os
from openai import OpenAI
from datetime import datetime

logger = logging.getLogger(__name__)


class PostGenerator:
    """Generates mystical channel posts based on news"""
    
    def __init__(self):
        self.api_key = os.getenv("OPENAI_API_KEY")
        if not self.api_key:
            raise ValueError("OPENAI_API_KEY not found in environment variables")
        
        self.system_message = """Ð¢Ñ‹ â€” Ð°Ð²Ñ‚Ð¾Ñ€ Telegram-ÐºÐ°Ð½Ð°Ð»Ð°, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ ÑÐ¾ÐµÐ´Ð¸Ð½ÑÐµÑ‚ Ð¼Ð¸Ñ€Ð¾Ð²Ñ‹Ðµ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ Ñ‡ÐµÑ€ÐµÐ· Ð¿Ñ€Ð¸Ð·Ð¼Ñƒ Ð¢Ð°Ñ€Ð¾ Ð¸ Ð¼Ð¸ÑÑ‚Ð¸ÐºÐ¸.

Ð¢Ð’ÐžÐ¯ Ð—ÐÐ”ÐÐ§Ð:
Ð¡Ð¾Ð·Ð´Ð°Ð²Ð°Ñ‚ÑŒ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¸Ðµ, ÑÐ¼Ð¾Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ðµ, Ð¼Ð¸ÑÑ‚Ð¸Ñ‡ÐµÑÐºÐ¸-Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ðµ Ð¿Ð¾ÑÑ‚Ñ‹ Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ Ð°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ñ… Ð½Ð¾Ð²Ð¾ÑÑ‚ÐµÐ¹.

Ð¡Ð¢Ð˜Ð›Ð¬:
- ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¸Ðµ Ð°Ð±Ð·Ð°Ñ†Ñ‹ (2-4 Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ)
- ÑÐ·Ñ‹Ðº Ð¿Ñ€Ð¾ÑÑ‚Ð¾Ð¹, Ð¶Ð¸Ð²Ð¾Ð¹, Ð½Ð¾ Ð¼ÑƒÐ´Ñ€Ñ‹Ð¹
- Ð»Ñ‘Ð³ÐºÐ°Ñ Ð¼Ð¸ÑÑ‚Ð¸ÐºÐ°, Ð±ÐµÐ· ÑÐ·Ð¾Ñ‚ÐµÑ€Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ð¿ÐµÑ€ÐµÐ³Ñ€ÑƒÐ·Ð°
- Ð¼Ð°ÐºÑÐ¸Ð¼ÑƒÐ¼ 1-2 ÑÐ¼Ð¾Ð´Ð·Ð¸
- Ð½Ð¸ÐºÐ°ÐºÐ¸Ñ… Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… Ð¾Ñ†ÐµÐ½Ð¾Ðº, Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÑÐ½ÐµÑ€Ð³ÐµÑ‚Ð¸ÐºÐ° Ð¸ ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¸Ð·Ð¼
- Ð¾Ñ‰ÑƒÑ‰ÐµÐ½Ð¸Ðµ, Ñ‡Ñ‚Ð¾ Ð½Ð¾Ð²Ð¾ÑÑ‚Ð¸ â€” ÑÑ‚Ð¾ ÑÐ¸Ð³Ð½Ð°Ð»Ñ‹ Ð’ÑÐµÐ»ÐµÐ½Ð½Ð¾Ð¹

Ð¡Ð¢Ð Ð£ÐšÐ¢Ð£Ð Ð ÐŸÐžÐ¡Ð¢Ð:
1) ÐŸÐµÑ€Ð²Ð¾Ðµ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ â€” ÐºÑ€ÑŽÑ‡Ð¾Ðº (Ð¸Ð½Ñ‚Ñ€Ð¸Ð³ÑƒÑŽÑ‰ÐµÐµ Ð½Ð°Ñ‡Ð°Ð»Ð¾)
2) ÐšÐ¾Ñ€Ð¾Ñ‚ÐºÐ¾ Ð¾ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ð¸ (1-2 Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ, Ð±ÐµÐ· Ð»Ð¸ÑˆÐ½Ð¸Ñ… Ð´ÐµÑ‚Ð°Ð»ÐµÐ¹)
3) ÐœÐ¸ÑÑ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð¾Ð±ÑŠÑÑÐ½ÐµÐ½Ð¸Ðµ:
   - Ñ‡Ñ‚Ð¾ ÑÑ‚Ð¾ Ð³Ð¾Ð²Ð¾Ñ€Ð¸Ñ‚ Ð¾ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð¸Ð¸ Ð¼Ð¸Ñ€Ð°
   - ÐºÐ°ÐºÐ°Ñ ÑÐ½ÐµÑ€Ð³Ð¸Ñ Ñ€Ð°ÑÐºÑ€Ñ‹Ð²Ð°ÐµÑ‚ÑÑ
   - Ñ‡Ñ‚Ð¾ ÑÑ‚Ð¾ Ð·Ð½Ð°Ñ‡Ð¸Ñ‚ Ð´Ð»Ñ Ð»ÑŽÐ´ÐµÐ¹
4) ÐœÐ¸Ð½Ð¸-ÑÐ¾Ð²ÐµÑ‚ Ð¸Ð»Ð¸ Ð½Ð°Ð±Ð»ÑŽÐ´ÐµÐ½Ð¸Ðµ
5) ÐžÐ‘Ð¯Ð—ÐÐ¢Ð•Ð›Ð¬ÐÐž Ð² ÐºÐ¾Ð½Ñ†Ðµ Ñ‚Ñ‘Ð¿Ð»Ñ‹Ð¹ Ð¿Ñ€Ð¸Ð·Ñ‹Ð² Ðº Ð±Ð¾Ñ‚Ñƒ

Ð’ÐÐ–ÐÐž:
- ÐÐ• ÐšÐžÐŸÐ˜Ð Ð£Ð™ Ð¿Ñ€Ð¸Ð¼ÐµÑ€Ñ‹, ÑÐ¾Ð·Ð´Ð°Ð²Ð°Ð¹ ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ñ‹Ðµ Ð¿Ð¾ÑÑ‚Ñ‹
- ÐÐµ Ð¿Ð¸ÑˆÐ¸ Ð´Ð»Ð¸Ð½Ð½Ñ‹Ñ… Ñ‚ÐµÐºÑÑ‚Ð¾Ð² (Ð¼Ð°ÐºÑ 150 ÑÐ»Ð¾Ð²)
- ÐÐµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ ÑÐ»Ð¾Ð¶Ð½Ñ‹Ðµ Ñ‚ÐµÑ€Ð¼Ð¸Ð½Ñ‹
- ÐÐµ Ð¿Ñ€ÐµÐ´ÑÐºÐ°Ð·Ñ‹Ð²Ð°Ð¹ ÑÐ¼ÐµÑ€Ñ‚Ð¸, Ð²Ð¾Ð¹Ð½Ñ‹, ÐºÐ°Ñ‚Ð°ÑÑ‚Ñ€Ð¾Ñ„Ñ‹
- Ð¤Ð¾ÐºÑƒÑÐ¸Ñ€ÑƒÐ¹ÑÑ Ð½Ð° ÑÐ½ÐµÑ€Ð³Ð¸Ð¸, ÑÐ¼Ñ‹ÑÐ»Ðµ, Ð²Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½ÐµÐ¼ Ð¾Ñ‚Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¸
- Ð˜Ð·Ð±ÐµÐ³Ð°Ð¹ Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… Ð¾Ð±Ð²Ð¸Ð½ÐµÐ½Ð¸Ð¹
- ÐšÐ°Ð¶Ð´Ñ‹Ð¹ Ð¿Ð¾ÑÑ‚ ÑÐ°Ð¼Ð¾ÑÑ‚Ð¾ÑÑ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹

Ð¤Ð˜ÐÐÐ› ÐšÐÐ–Ð”ÐžÐ“Ðž ÐŸÐžÐ¡Ð¢Ð:
"Ð¥Ð¾Ñ‡ÐµÑˆÑŒ ÑƒÐ·Ð½Ð°Ñ‚ÑŒ, Ñ‡Ñ‚Ð¾ ÑÑ‚Ð¾ Ð·Ð½Ð°Ñ‡Ð¸Ñ‚ Ð»Ð¸Ñ‡Ð½Ð¾ Ð´Ð»Ñ Ñ‚ÐµÐ±Ñ? â†’ @taro208_bot"

ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹ Ð¢ÐžÐ›Ð¬ÐšÐž Ñ‚ÐµÐºÑÑ‚Ð¾Ð¼ Ð¿Ð¾ÑÑ‚Ð°, Ð±ÐµÐ· Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ñ… Ð¿Ð¾ÑÑÐ½ÐµÐ½Ð¸Ð¹."""
    
    async def generate_post(self, news_data: dict, time_of_day: str = None) -> str:
        """
        Generate mystical post based on news
        
        Args:
            news_data: Dict with news information
            time_of_day: Optional time context (morning, day, evening, night)
            
        Returns:
            str: Generated post text
        """
        client = OpenAI(api_key=self.api_key)
        
        # Get time context
        if time_of_day is None:
            hour = datetime.now().hour
            if 6 <= hour < 12:
                time_of_day = "ÑƒÑ‚Ñ€Ð¾Ð¼"
            elif 12 <= hour < 18:
                time_of_day = "Ð´Ð½Ñ‘Ð¼"
            elif 18 <= hour < 23:
                time_of_day = "Ð²ÐµÑ‡ÐµÑ€Ð¾Ð¼"
            else:
                time_of_day = "Ð½Ð¾Ñ‡ÑŒÑŽ"
        
        topic = news_data.get('topic', 'general')
        results = news_data.get('results', '')
        
        # Topic context with emojis
        topic_contexts = {
            "space": "ÐºÐ¾ÑÐ¼Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ð¸ÑÑ… Ð¸ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸ÑÑ… Ð·Ð° Ð¿Ñ€ÐµÐ´ÐµÐ»Ð°Ð¼Ð¸ Ð—ÐµÐ¼Ð»Ð¸ ðŸŒŒ",
            "science": "Ð½Ð°ÑƒÑ‡Ð½Ñ‹Ñ… Ð¿Ñ€Ð¾Ñ€Ñ‹Ð²Ð°Ñ… Ð¸ Ð¸ÑÑÐ»ÐµÐ´Ð¾Ð²Ð°Ð½Ð¸ÑÑ… ðŸ”¬",
            "technology": "Ñ‚ÐµÑ…Ð½Ð¾Ð»Ð¾Ð³Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… Ð½Ð¾Ð²Ð¸Ð½ÐºÐ°Ñ… Ð¸ Ð¸Ð·Ð¾Ð±Ñ€ÐµÑ‚ÐµÐ½Ð¸ÑÑ… ðŸ¤–",
            "nature": "Ð¿Ñ€Ð¸Ñ€Ð¾Ð´Ð½Ñ‹Ñ… ÑÐ²Ð»ÐµÐ½Ð¸ÑÑ… Ð¸ ÑÐºÐ¾Ð»Ð¾Ð³Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… ÑÐ¾Ð±Ñ‹Ñ‚Ð¸ÑÑ… ðŸŒ¿",
            "energy": "ÑÐ½ÐµÑ€Ð³ÐµÑ‚Ð¸ÐºÐµ Ð´Ð½Ñ Ð¸ Ð°ÑÑ‚Ñ€Ð¾Ð»Ð¾Ð³Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… Ð²Ð»Ð¸ÑÐ½Ð¸ÑÑ… âœ¨",
            "culture": "ÐºÑƒÐ»ÑŒÑ‚ÑƒÑ€Ð½Ñ‹Ñ… ÑÐ¾Ð±Ñ‹Ñ‚Ð¸ÑÑ… Ð¸ ÑÐ¾Ñ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ñ… Ñ‚ÐµÐ½Ð´ÐµÐ½Ñ†Ð¸ÑÑ… ðŸŽ­",
            "mystical": "Ð¼Ð¸ÑÑ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… Ð·Ð½Ð°ÐºÐ°Ñ… Ð¸ Ñ†Ð¸ÐºÐ»Ð°Ñ… Ð¿Ñ€Ð¸Ñ€Ð¾Ð´Ñ‹ ðŸ”®"
        }
        
        topic_context = topic_contexts.get(topic, "Ð¼Ð¸Ñ€Ð¾Ð²Ñ‹Ñ… ÑÐ¾Ð±Ñ‹Ñ‚Ð¸ÑÑ…")
        
        prompt = f"""Ð¡ÐµÐ¹Ñ‡Ð°Ñ {time_of_day}. Ð¡Ð¾Ð·Ð´Ð°Ð¹ Ð¼Ð¸ÑÑ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð¿Ð¾ÑÑ‚ Ð´Ð»Ñ Telegram-ÐºÐ°Ð½Ð°Ð»Ð° Ð¾ {topic_context}.

Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¸Ð· Ð½Ð¾Ð²Ð¾ÑÑ‚ÐµÐ¹:
{results[:1500]}

Ð¡Ð¾Ð·Ð´Ð°Ð¹ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¸Ð¹ (100-150 ÑÐ»Ð¾Ð²), Ð¶Ð¸Ð²Ð¾Ð¹, Ð¼Ð¸ÑÑ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð¿Ð¾ÑÑ‚:
1. ÐÐ°Ñ‡Ð½Ð¸ Ñ Ð¸Ð½Ñ‚Ñ€Ð¸Ð³ÑƒÑŽÑ‰ÐµÐ³Ð¾ ÐºÑ€ÑŽÑ‡ÐºÐ°
2. ÐšÑ€Ð°Ñ‚ÐºÐ¾ Ð¾ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ð¸
3. ÐœÐ¸ÑÑ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð¾Ð±ÑŠÑÑÐ½ÐµÐ½Ð¸Ðµ ÑÐ½ÐµÑ€Ð³Ð¸Ð¸
4. Ð¡Ð¾Ð²ÐµÑ‚ Ð¸Ð»Ð¸ Ð½Ð°Ð±Ð»ÑŽÐ´ÐµÐ½Ð¸Ðµ
5. ÐžÐ‘Ð¯Ð—ÐÐ¢Ð•Ð›Ð¬ÐÐž Ð·Ð°Ð²ÐµÑ€ÑˆÐ°Ð¹: "Ð¥Ð¾Ñ‡ÐµÑˆÑŒ ÑƒÐ·Ð½Ð°Ñ‚ÑŒ, Ñ‡Ñ‚Ð¾ ÑÑ‚Ð¾ Ð·Ð½Ð°Ñ‡Ð¸Ñ‚ Ð»Ð¸Ñ‡Ð½Ð¾ Ð´Ð»Ñ Ñ‚ÐµÐ±Ñ? â†’ @taro208_bot"

ÐÐ• ÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐ¹ Ð¿Ñ€Ð¸Ð¼ÐµÑ€Ñ‹. Ð¡Ð¾Ð·Ð´Ð°Ð¹ ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¿Ð¾ÑÑ‚ Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ ÑÑ‚Ð¸Ñ… Ð½Ð¾Ð²Ð¾ÑÑ‚ÐµÐ¹.
ÐŸÐ¸ÑˆÐ¸ Ð½Ð° Ñ€ÑƒÑÑÐºÐ¾Ð¼ ÑÐ·Ñ‹ÐºÐµ, ÐµÑÑ‚ÐµÑÑ‚Ð²ÐµÐ½Ð½Ð¾ Ð¸ Ð¶Ð¸Ð²Ð¾."""
        
        response = client.chat.completions.create(
            model="gpt-4o",
            messages=[
                {"role": "system", "content": self.system_message},
                {"role": "user", "content": prompt}
            ]
        )
        
        result = response.choices[0].message.content
        logger.info(f"Generated post for topic '{topic}' ({len(result)} chars)")
        return result.strip()
    
    def validate_post(self, post: str) -> bool:
        """Validate generated post"""
        if not post or len(post) < 50:
            return False
        
        # Check for bot mention
        if "@taro208_bot" not in post:
            return False
        
        # Check length (not too long)
        if len(post) > 1000:
            return False
        
        return True
